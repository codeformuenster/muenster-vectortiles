<!DOCTYPE html>
<html>
<head>
    <meta charset='utf-8' />
    <title>Mapbox GL Inspect</title>
    <meta name='viewport' content='initial-scale=1,maximum-scale=1,user-scalable=no' />
    <link rel="stylesheet" href="https://unpkg.com/maplibre-gl@1.15.0/dist/maplibre-gl.css" crossorigin="anonymous">
    <script src="https://unpkg.com/maplibre-gl@1.15.0/dist/maplibre-gl.js" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/@mapbox/mapbox-gl-sync-move@0.3.0/index.min.js"></script>
    <script src="https://unpkg.com/long@4.0.0/dist/long.js"></script>
    <style>
        body { margin:0; padding:0; }
        #map1 { position:absolute; top:0; left: 0; width:50%; height: 100% }
        #map2 { position:absolute; top:0; right: 0; width:50%; height: 100% }
        #menu { position: absolute; background: #fff; padding: 10px; font-family: 'Open Sans', sans-serif; }
        .bigger { font-size: 16px; color: gray }
    </style>
</head>
<body>

<div id='map1'></div>
<div id='map2'></div>
<script>
    let center = [121.54648,25.0457]
    let zoom = 12
    var map1 = new maplibregl.Map({
        container: 'map1',
        style: './styles/simple.json',
        center: center,
        zoom: zoom,
        hash: true
    });
    var map2 = new maplibregl.Map({
        container: 'map2',
        style: {
            version: 8,
            name: "rudymap",
            sources: {
                osm: {
                    type: "raster",
                        tiles: [ "http://tile.happyman.idv.tw/mp/wmts/rudy/gm_grid/{z}/{x}/{y}.png" ],
                    minzoom: 0,
                    maxzoom: 17
                }
            },
            layers: [ { id: "osm", type: "raster", source: "osm", } ]
        },
        center: center,
        zoom: zoom
    });

    syncMaps(map1, map2)
    map1.showTileBoundaries=true;
    map2.showTileBoundaries=true;

    var popup = new maplibregl.Popup({ closeOnMove: true, closeButton: false})
    var features
    map1.on('contextmenu', e => {
        var p = e.point
        features = map1.queryRenderedFeatures([[p.x-10, p.y-10], [p.x+10, p.y+10]])
        popup.remove()
        if (features.length == 1) {
            popup.addTo(map1)
            popup.setHTML(getFeatureHTML(features[0]))
            popup.setLngLat(e.lngLat)
        } else if (features.length > 0) {
            popup.addTo(map1)
            popup.setHTML(getSelectionHTML(features))
            popup.setLngLat(e.lngLat)
        }
    })

    function getSelectionHTML (features) {
        var info = `<select id="selection" multiple size=${features.length} onchange="selectFeature(this.selectedIndex);">`
        features.forEach(function(f) {
            info += `<option>${f.properties["name"] ? f.properties["name"] : f.layer.id}</option>`
        })
        info += '</select>'
        return info
    }

    function selectFeature (index) {
        popup.remove()
        popup.addTo(map1)
        popup.setHTML(getFeatureHTML(features[index]))
        popup.setLngLat(e.lngLat)
    }

    function getFeatureHTML (feature) {
        const l = new Long.fromNumber(feature.id)
        const layer = l.shru(46).toInt()
        const mask = Long.MAX_UNSIGNED_VALUE.shru(64-44)
        const source_id = l.and(mask).toString()
        var props = ['name']
        Object.keys(feature.properties)
            .sort()
            .forEach(function(p) {
                if (props.indexOf(p) === -1) props.push(p)
            })
            var info = `<div class="featureTable"><b class="bigger">${feature.layer.id}</b>`
        props.forEach(function(p) {
            if (feature.properties[p]) {
                var value = feature.properties[p]
                if (p == 'id') {
                    value = `<a href="https://openstreetmap.org/${value}" target="_blank">${value}</a>`
                }
                info += `
                   <div class="featureRow"><div class="featureCell"><b>${p}</b></div>
                   <div class="featureCell">${value}</div></div>
                `
            }
        })
        info += '</div>'
        return info
    }
</script>

</body>
</html>
